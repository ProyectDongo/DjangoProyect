{% extends 'base.html' %}
{% block title %}Registrar Ejercicio{% endblock %}
{% block content %}
<div class="container py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
                <div class="mb-3 mb-md-0">
                    <h1 class="h2 mb-1 text-gradient">
                        <i class="bi bi-pencil-square me-2"></i>Registrar Ejercicio
                    </h1>
                    <p class="text-muted mb-0">{{ workout_exercise.exercise.name }} - {{ workout_exercise.workout.title }}</p>
                </div>
                <a href="{% url 'view_plan' workout_exercise.workout.plan.id %}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-left me-1"></i>Volver al Plan
                </a>
            </div>
        </div>
    </div>

    <!-- Video Section -->
    {% if workout_exercise.exercise.video_url %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-play-circle-fill text-primary fs-4 me-3"></i>
                        <div>
                            <h6 class="mb-1">Video del Ejercicio</h6>
                            <p class="mb-0 text-muted small">Revisa la técnica correcta para este ejercicio</p>
                        </div>
                        <a href="{{ workout_exercise.exercise.video_url }}" target="_blank" class="btn btn-primary btn-sm ms-auto">
                            <i class="bi bi-play-btn me-1"></i>Ver Video
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Main Content -->
    <div class="row">
        <!-- Exercise Details Column -->
        <div class="col-lg-8 mb-4">
            <!-- Exercise Details Card -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-light py-3">
                    <h5 class="mb-0 text-primary">
                        <i class="bi bi-clipboard-data me-2"></i>Detalles del Ejercicio
                    </h5>
                </div>
                <div class="card-body p-4">
                    <div class="row g-4">
                        <!-- Trainer Goals -->
                        <div class="col-md-6">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="card-title text-primary mb-3">
                                        <i class="bi bi-bullseye me-2"></i>Objetivo del Entrenador
                                    </h6>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="badge bg-primary me-2">S</span>
                                                <span class="small">{{ workout_exercise.sets }} Series</span>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <span class="badge bg-primary me-2">R</span>
                                                <span class="small">{{ workout_exercise.reps_target }} Reps</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="badge bg-warning me-2">RIR</span>
                                                <span class="small">{{ workout_exercise.rir_target }}</span>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <span class="badge bg-info me-2">RPE</span>
                                                <span class="small">{{ workout_exercise.rpe_target }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    {% if workout_exercise.notes %}
                                    <div class="mt-3 pt-2 border-top">
                                        <p class="small mb-0"><strong>Notas:</strong> {{ workout_exercise.notes }}</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Best Record -->
                        <div class="col-md-6">
                            <div class="card h-100 border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="card-title text-success mb-3">
                                        <i class="bi bi-trophy me-2"></i>Tu Mejor Registro
                                    </h6>
                                    {% if best_log %}
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="badge bg-success me-2">W</span>
                                                <span class="small">{{ best_log.weight_lifted_kg }} kg</span>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <span class="badge bg-success me-2">R</span>
                                                <span class="small">{{ best_log.reps_completed }} Reps</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="badge bg-warning me-2">RIR</span>
                                                <span class="small">{{ best_log.rir_actual }}</span>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <span class="badge bg-secondary me-2">D</span>
                                                <span class="small">{{ best_log.date_completed|date:"d/m/Y" }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="text-center py-3">
                                        <i class="bi bi-inbox text-muted fs-1"></i>
                                        <p class="text-muted mt-2 mb-0">No hay registros anteriores</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Exercise Log Form -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-light py-3">
                    <h5 class="mb-0 text-primary">
                        <i class="bi bi-plus-circle me-2"></i>Registrar Ejercicio
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data" id="exerciseForm">
                        {% csrf_token %}
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="id_weight_lifted_kg" class="form-label fw-semibold">
                                    <i class="bi bi-speedometer2 me-1"></i>Peso (kg)
                                </label>
                                <div class="input-group">
                                    {{ form.weight_lifted_kg }}
                                    <span class="input-group-text">kg</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="id_reps_completed" class="form-label fw-semibold">
                                    <i class="bi bi-arrow-repeat me-1"></i>Repeticiones Completadas
                                </label>
                                {{ form.reps_completed }}
                            </div>
                        </div>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="id_rir_actual" class="form-label fw-semibold">
                                    <i class="bi bi-activity me-1"></i>RIR Real
                                </label>
                                {{ form.rir_actual }}
                            </div>
                            <div class="col-md-6">
                                <label for="id_rpe_actual" class="form-label fw-semibold">
                                    <i class="bi bi-graph-up me-1"></i>RPE Real
                                </label>
                                {{ form.rpe_actual }}
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="id_notes" class="form-label fw-semibold">
                                <i class="bi bi-chat-text me-1"></i>Notas
                            </label>
                            {{ form.notes }}
                        </div>
                        <div class="mb-4">
                            <label for="id_video_log" class="form-label fw-semibold">
                                <i class="bi bi-camera-video me-1"></i>Video (opcional{% if workout_exercise.video_required %} - Requerido{% endif %})
                            </label>
                            {{ form.video_log }}
                            <small class="form-text text-muted">
                                Tip: Para subir más rápido, graba en resolución baja (720p o menos). 
                                - iPhone: Ajustes > Cámara > Grabar Video > 720p HD a 30 cps.
                                - Android: App Cámara > Configuración > Resolución Video > HD (720p).
                                Si el video es grande, se comprimirá automáticamente antes de subir (reduce a 720p). 
                                Usa apps como "Video Compressor" si prefieres manual. Máximo: 200MB.
                            </small>
                        </div>
                        <!-- Barra de progreso -->
                        <div class="progress mb-3" id="progressBar" style="display: none; height: 20px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                        </div>
                        <div class="mb-4">
                            <label for="id_status" class="form-label fw-semibold">
                                <i class="bi bi-check-circle me-1"></i>Estado
                            </label>
                            {{ form.status }}
                        </div>
                        <div class="d-flex flex-column flex-sm-row justify-content-between gap-3">
                            <a href="{% url 'view_plan' workout_exercise.workout.plan.id %}" class="btn btn-secondary order-2 order-sm-1">
                                <i class="bi bi-x-circle me-1"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-excel order-1 order-sm-2" id="submitReportBtn">
                                <i class="bi bi-send me-1"></i>Enviar Reporte
                                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- RPE/RIR Reference Column -->
        <div class="col-lg-4">
            <div class="card shadow-sm border-0 sticky-top" style="top: 20px;">
                <div class="card-header bg-light py-3">
                    <h5 class="mb-0 text-primary">
                        <i class="bi bi-info-circle me-2"></i>Referencia RPE/RIR
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered mb-0 rpe-table">
                            <thead class="table-primary">
                                <tr>
                                    <th class="text-center">RPE</th>
                                    <th class="text-center">RIR</th>
                                    <th>Descripción</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="exercise-row">
                                    <td class="text-center fw-bold">10.0</td>
                                    <td class="text-center fw-bold">0.0</td>
                                    <td class="small">Máximo esfuerzo, no puede hacer más repeticiones</td>
                                </tr>
                                <tr class="exercise-row">
                                    <td class="text-center fw-bold">9.5</td>
                                    <td class="text-center fw-bold">0-1</td>
                                    <td class="small">Podría haber hecho 0-1 repetición más</td>
                                </tr>
                                <tr class="exercise-row">
                                    <td class="text-center fw-bold">9.0</td>
                                    <td class="text-center fw-bold">1.0</td>
                                    <td class="small">Te quedan 1 repetición más</td>
                                </tr>
                                <tr class="exercise-row">
                                    <td class="text-center fw-bold">8.5</td>
                                    <td class="text-center fw-bold">1-2</td>
                                    <td class="small">Te quedan 1-2 repeticiones más</td>
                                </tr>
                                <tr class="exercise-row">
                                    <td class="text-center fw-bold">8.0</td>
                                    <td class="text-center fw-bold">2.0</td>
                                    <td class="small">Te quedan 2 repeticiones más</td>
                                </tr>
                                <tr class="exercise-row">
                                    <td class="text-center fw-bold">7.5</td>
                                    <td class="text-center fw-bold">2-3</td>
                                    <td class="small">Te quedan 2-3 repeticiones más</td>
                                </tr>
                                <tr class="exercise-row">
                                    <td class="text-center fw-bold">7.0</td>
                                    <td class="text-center fw-bold">3.0</td>
                                    <td class="small">Te quedan 3 repeticiones más</td>
                                </tr>
                                <tr class="exercise-row">
                                    <td class="text-center fw-bold">≤6.0</td>
                                    <td class="text-center fw-bold">≥4.0</td>
                                    <td class="small">Calentamiento o muy poca carga</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-3 bg-light border-top">
                        <p class="small text-muted mb-0">
                            <i class="bi bi-lightbulb me-1"></i>
                            <strong>RPE</strong> = Percepción Subjetiva del Esfuerzo | 
                            <strong>RIR</strong> = Repeticiones en Reserva
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Overlay simple para loading (reemplaza al modal) -->
<div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; text-align: center; color: white;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3" id="loadingMessage">Subiendo video, por favor espere... No cierre la página.</p>
    </div>
</div>

<style>
    /* Estilos para overlay (ajusta si necesitas) */
    #loadingOverlay {
        backdrop-filter: blur(5px);  /* Blur para UX en móviles */
    }
    body.loading-overlay-active {
        overflow: hidden !important;
        position: fixed;
        width: 100%;
    }
</style>

<!-- Script de FFmpeg (versión confirmada como la más reciente al 25/09/2025) -->
<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.15/dist/umd/ffmpeg.js"></script>

<script>
    // Esperar a que el DOM esté cargado
    document.addEventListener('DOMContentLoaded', function() {
        // FFmpeg ya no se desestructura aquí para evitar errores prematuros. Se maneja dentro de compressIfNeeded.

        function handleUploadWithProgress(form, progressBar, progressFill, successUrl) {
            console.log('Starting upload process');
            const submitBtn = document.getElementById('submitReportBtn');
            const videoInput = document.getElementById('id_video_log');
            const formData = new FormData(form);
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingMessage = document.getElementById('loadingMessage');

            // Mostrar loading en botón
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Procesando... <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

            // Mostrar overlay y progreso al inicio
            console.log('Showing overlay at start');
            loadingOverlay.style.display = 'block';
            document.body.classList.add('loading-overlay-active');  // Bloquear scroll
            progressBar.style.display = 'block';
            loadingMessage.textContent = 'Preparando envío... No cierre la página.';

            if (videoInput.files.length) {
                let file = videoInput.files[0];
                const maxSize = 200 * 1024 * 1024;
                const ext = file.name.split('.').pop().toLowerCase();
                const allowedExtensions = ['mp4', 'avi', 'mov'];

                if (!allowedExtensions.includes(ext)) {
                    resetSubmitBtn(submitBtn);
                    hideOverlay();
                    progressBar.style.display = 'none';
                    alert('Extensión no permitida. Solo mp4, avi, mov.');
                    return;
                }
                if (!file.type.startsWith('video/')) {
                    resetSubmitBtn(submitBtn);
                    hideOverlay();
                    progressBar.style.display = 'none';
                    alert('El archivo no es un video válido.');
                    return;
                }
                if (file.size > maxSize) {
                    resetSubmitBtn(submitBtn);
                    hideOverlay();
                    progressBar.style.display = 'none';
                    alert('El video es demasiado grande (máx 200MB).');
                    return;
                }

                // Compresión con try/catch adicional
                async function compressIfNeeded() {
                    if (file.size > 10 * 1024 * 1024) {
                        loadingMessage.textContent = 'Comprimiendo video para subir más rápido... No cierre la página.';
                        try {
                            // Desestructuramos FFmpeg aquí, solo cuando es necesario
                            if (typeof FFmpeg === 'undefined') {
                                throw new Error('FFmpeg library not loaded');
                            }
                            const { createFFmpeg, fetchFile } = FFmpeg;
                            // Modo single-threaded para compatibilidad en móviles
                            const ffmpeg = createFFmpeg({
                                log: true,
                                corePath: 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.js'
                            });

                            if (typeof SharedArrayBuffer === 'undefined') {
                                console.log('No SharedArrayBuffer, skipping compression');
                                throw new Error('Skipping compression due to browser compatibility');
                            }

                            if (!ffmpeg.isLoaded()) await ffmpeg.load();
                            const inputName = 'input.' + ext;
                            const outputName = 'output.mp4';
                            ffmpeg.FS('writeFile', inputName, await fetchFile(file));
                            await ffmpeg.run('-i', inputName, '-vf', 'scale=-2:720', '-c:v', 'libx264', '-crf', '28', '-preset', 'fast', '-b:v', '1000k', outputName);
                            const data = ffmpeg.FS('readFile', outputName);
                            file = new File([data.buffer], 'compressed.mp4', { type: 'video/mp4' });
                            console.log('Compression done, new size:', file.size);
                        } catch (err) {
                            console.error('Compression error:', err);
                            loadingMessage.textContent = 'Subiendo video sin compresión... No cierre la página.';
                            // Continuar sin compresión, overlay permanece visible
                        }
                    }
                    loadingMessage.textContent = 'Subiendo video... No cierre la página.';
                    uploadMultipart(file);
                }

                // Subida multipart
                function uploadMultipart(fileToUpload) {
                    const chunkSize = 5 * 1024 * 1024;
                    const chunks = Math.ceil(fileToUpload.size / chunkSize);
                    const initData = new FormData();
                    initData.append('file_name', fileToUpload.name);
                    initData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                    
                    fetch('{% url "initiate_multipart_upload" %}', {
                        method: 'POST',
                        body: initData
                    }).then(response => {
                        if (!response.ok) throw new Error('Initiate failed: ' + response.statusText);
                        return response.json();
                    }).then(data => {
                        if (data.error) throw new Error(data.error);
                        const uploadId = data.upload_id;
                        const key = data.key;
                        let parts = [];
                        let completed = 0;
                        let uploadedBytes = 0;
                        
                        for (let i = 0; i < chunks; i++) {
                            let start = i * chunkSize;
                            let end = Math.min(start + chunkSize, fileToUpload.size);
                            let chunk = fileToUpload.slice(start, end);
                            
                            const partData = new FormData();
                            partData.append('key', key);
                            partData.append('upload_id', uploadId);
                            partData.append('part_number', i + 1);
                            partData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                            
                            fetch('{% url "generate_presigned_part" %}', {
                                method: 'POST',
                                body: partData
                            }).then(res => {
                                if (!res.ok) throw new Error('Generate part failed: ' + res.statusText);
                                return res.json();
                            }).then(part => {
                                if (part.error) throw new Error(part.error);
                                const xhr = new XMLHttpRequest();
                                xhr.open('PUT', part.url, true);
                                // No establecer Content-Type para parts, para evitar mismatch de signature
                                
                                xhr.upload.onprogress = function(event) {
                                    if (event.lengthComputable) {
                                        const chunkProgress = event.loaded / event.total;
                                        const totalPercent = Math.round(((uploadedBytes + (chunkProgress * (end - start))) / fileToUpload.size) * 100);
                                        progressFill.style.width = totalPercent + '%';
                                        progressFill.textContent = totalPercent + '%';
                                    }
                                };
                                
                                xhr.onload = function() {
                                    if (xhr.status === 200) {
                                        const etag = xhr.getResponseHeader('ETag').replace(/"/g, '');
                                        parts.push({ ETag: etag, PartNumber: i + 1 });
                                        completed++;
                                        uploadedBytes += (end - start);
                                        if (completed === chunks) {
                                            const completeData = new FormData();
                                            completeData.append('key', key);
                                            completeData.append('upload_id', uploadId);
                                            completeData.append('parts', JSON.stringify(parts));
                                            completeData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                                            
                                            fetch('{% url "complete_multipart_upload" %}', {
                                                method: 'POST',
                                                body: completeData
                                            }).then(res => {
                                                if (!res.ok) throw new Error('Complete failed: ' + res.statusText);
                                                return res.json();
                                            }).then(complete => {
                                                if (complete.success) {
                                                    formData.delete('video_log');
                                                    formData.append('video_key', key);
                                                    fetch(form.action, {
                                                        method: 'POST',
                                                        body: formData
                                                    }).then(response => {
                                                        resetSubmitBtn(submitBtn);
                                                        progressBar.style.display = 'none';
                                                        hideOverlay();
                                                        if (response.ok || response.redirected) {
                                                            window.location.href = successUrl;
                                                        } else {
                                                            alert('Error en submit final');
                                                        }
                                                    }).catch(err => {
                                                        resetSubmitBtn(submitBtn);
                                                        hideOverlay();
                                                        progressBar.style.display = 'none';
                                                        alert('Error en submit final: ' + err);
                                                    });
                                                } else {
                                                    throw new Error('Complete failed');
                                                }
                                            }).catch(err => {
                                                resetSubmitBtn(submitBtn);
                                                hideOverlay();
                                                progressBar.style.display = 'none';
                                                alert('Error completando upload: ' + err);
                                            });
                                        }
                                    } else {
                                        throw new Error('Part upload failed with status ' + xhr.status);
                                    }
                                };
                                
                                xhr.onerror = function() {
                                    resetSubmitBtn(submitBtn);
                                    hideOverlay();
                                    progressBar.style.display = 'none';
                                    alert('Error de red durante la subida de parte');
                                };
                                
                                xhr.send(chunk);
                            }).catch(err => {
                                resetSubmitBtn(submitBtn);
                                hideOverlay();
                                progressBar.style.display = 'none';
                                alert('Error generando URL para parte: ' + err);
                            });
                        }
                    }).catch(err => {
                        resetSubmitBtn(submitBtn);
                        hideOverlay();
                        progressBar.style.display = 'none';
                        alert('Error iniciando multipart: ' + err);
                    });
                }

                // Iniciar proceso
                compressIfNeeded().catch(err => {
                    console.error('Global compression error:', err);
                    alert('Error en compresión: ' + err + '. Intentando subir original...');
                    loadingMessage.textContent = 'Subiendo video sin compresión... No cierre la página.';
                    uploadMultipart(file);  // Fallback con overlay visible
                });
            } else {
                // Sin video
                loadingMessage.textContent = 'Enviando reporte... No cierre la página.';
                fetch(form.action, {
                    method: 'POST',
                    body: formData
                }).then(response => {
                    resetSubmitBtn(submitBtn);
                    progressBar.style.display = 'none';
                    hideOverlay();
                    if (response.ok || response.redirected) {
                        window.location.href = successUrl;
                    } else {
                        alert('Error en la subida');
                    }
                }).catch(err => {
                    resetSubmitBtn(submitBtn);
                    hideOverlay();
                    progressBar.style.display = 'none';
                    alert('Error de red: ' + err);
                });
            }
        }

        function resetSubmitBtn(btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-send me-1"></i>Enviar Reporte';
        }

        function hideOverlay() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'none';
            document.body.classList.remove('loading-overlay-active');
        }

        // Listener para el form
        document.querySelector('#exerciseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const progressBar = document.getElementById('progressBar');
            const progressFill = progressBar.querySelector('.progress-bar');
            handleUploadWithProgress(this, progressBar, progressFill, '{% url "view_plan" workout_exercise.workout.plan.id %}');
        });
    });
</script>
{% endblock %}